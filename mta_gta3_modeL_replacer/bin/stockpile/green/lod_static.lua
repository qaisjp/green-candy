-- File generated by MTASA model importer
local modelsLoaded={};
local textureCache = {};
local streamedObjects = {};
local pModels = {};

setCloudsEnabled(false);
debug.sethook(nil);

setFogDistance(800);
setFarClipDistance(1500);

local function getResourceSize(path)
	if not (fileExists(path)) then return 0; end;

	local file = fileOpen(path);
	local size = fileGetSize(file)

	fileClose(file);
	return size;
end

local function requestTexture(path)
	local txd = textureCache[path];

	if not (txd) then
		local size = getResourceSize(path);
		if (size == 0) then return false; end

		txd = engineLoadTXD(path);

		if not (txd) then
			return false;
		end

		textureCache[path] = txd;
	end
	return txd;
end

local function engineClumpObtainAtomic(dff)
	local atom = dff.getAtomics()[1];
	
	if not (atom) then return false; end;
	
	-- TODO: Setup the atomic rendering
	
	atom.setClump(nil);
	atom.setParent(nil);
	return atom;
end

function loadModels()
	local m,n;
	local file = fileOpen("lod_res.lua");

	for m,n in ipairs(loadstring(file.read(file.size()), "@lodRes")()) do
		local txd = requestTexture("textures/"..n[3]..".txd");
		txd.setGlobalEmitter();	-- Load from this txd
		
		local dff = engineLoadDFF("models/"..n[2]..".dff", 0);
		
		if (dff) then
			local atom = engineClumpObtainAtomic(dff);
			
			if not (atom) then
				outputDebugString("invalid model '" .. n[2] .. "'", 2);
			else
				pModels[n[1]] = {
					id = n[1],
					name = n[2],
					txd = txd,
					model = atom,
					lod = n[4] / 5,
					super = n[5]
				};
				pModelEntry = pModels[n[1]];
			end
			
			dff.destroy();
		else
			outputDebugString("invalid model '" .. n[2] .. "'", 2);
		end
	end
	
	file.destroy();
	file = fileOpen("model_res.lua");

	for n,m in ipairs(loadstring(file.read(file.size()), "@modelRes")()) do
		local txd = requestTexture("textures/"..m.txd_file..".txd");
		txd.setGlobalEmitter();
		
		local dff = engineLoadDFF("models/"..m.model_file..".dff", 0);
	
		if not (dff) then
			outputDebugString("invalid model '" .. m.model_file .. "'", 2);
		else
			local atom = engineClumpObtainAtomic(dff);
		
			if not (atom) then
				outputDebugString("invalid model '" .. m.model_file .. "'", 2);
			else
				pModels[m.model] = {
					id = m.model,
					name = m.model_file,
					txd = txd,
					model = atom,
					lod = m.lod,
					lodID = m.lodID
				};
				pModelEntry = pModels[m.model];
				pModelEntry.col=engineLoadCOL("coll/"..m.coll_file..".col");
				engineSetModelLODDistance(m.model, m.lod);
				
				pModelEntry.col.replace(m.model);
				atom.replace(m.model);
			end
			
			dff.destroy();
		end
	end
	
	file.destroy();
end
loadModels();

local objects = getElementsByType("object", resourceRoot);
local lodLinks = {};

for m,n in ipairs(objects) do
	local info = pModels[n.getModel()];
	local lodInfo = pModels[info.lodID];

	if (lodInfo) then
		local model = lodInfo.model;
		
		if (model) then
			local atom = model.clone();
			local frame = engineCreateFrame();
			
			-- Position the scene object
			local mat = frame.getLTM();
			mat.setEulerAngles(n.getRotation());
			mat.setPosition(n.getPosition());
			frame.setLTM(mat);
			mat.destroy();
			
			-- Assign the frame
			atom.setParent(frame);
		
			table.insert(lodLinks, {
				model = atom,
				obj = n,
				lod = info.lod
			});
		end
	end
end

addEventHandler("onClientGameRender", root, function()
		for m,n in ipairs(lodLinks) do
			local x,y,z = n.obj.getPosition();
			local dist = getDistanceBetweenPoints3D(x, y, z, camera.getPosition());
		
			if not (isElementOnScreen(n.obj)) or (dist > n.lod / 5) then
				if (dist < getFarClipDistance() + 100) then
					n.model.render();
				end
			end
		end
	end
);

addEventHandler("onClientResourceStop", resourceRoot, function()
		for m,n in pairs(pModels) do
			if (n.col) then n.col.destroy(); end
			if (n.model) then n.model.destroy(); end
			engineRestoreCOL(m);
			engineRestoreModel(m);
		end
	end
);

collectgarbage("collect");
setJetpackMaxHeight(1300);